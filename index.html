<!DOCTYPE html>
<html lang="ja">
<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-1V1ELMWFTY"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-1V1ELMWFTY');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Form Mirror Pro for PC ver 1.2.3</title>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5115190227060860" crossorigin="anonymous"></script>
    <style>
        :root {
            --primary: #0A84FF;
            --danger: #FF453A;
            --bg-glass: rgba(28, 28, 30, 0.85);
            --text-main: #FFFFFF;
            --text-sub: #8E8E93;
        }

        body { 
            margin: 0; background: #000; color: var(--text-main); 
            font-family: -apple-system, BlinkMacSystemFont, sans-serif; 
            overflow: hidden; width: 100%; height: 100%;
            user-select: none; 
        }
        
        canvas { width: 100vw; height: 100vh; object-fit: contain; background: #000; display: block; cursor: move; }
        
        .fade-ui { transition: opacity 0.3s ease, transform 0.3s ease; opacity: 0; pointer-events: none; }
        .ui-visible { opacity: 1; pointer-events: auto; transform: translateY(0); }

        .top-bar {
            position: fixed; top: 0; left: 0; right: 0;
            padding: 15px 20px;
            display: flex; justify-content: center; align-items: center; gap: 15px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
            z-index: 100;
        }

        .bottom-panel {
            position: fixed; bottom: 0; left: 50%; transform: translateX(-50%) translateY(20px);
            width: 90%; max-width: 900px;
            padding: 15px 20px;
            background: var(--bg-glass); border-top-left-radius: 24px; border-top-right-radius: 24px;
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            display: flex; flex-direction: column; gap: 10px; z-index: 100;
            border: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 10px; border-radius: 24px;
        }
        .bottom-panel.ui-visible { transform: translateX(-50%) translateY(0); }

        .sliders-row { display: flex; align-items: center; gap: 20px; justify-content: center; }
        .slider-group { display: flex; align-items: center; gap: 8px; font-size: 14px; }
        input[type="range"] { width: 100px; height: 4px; accent-color: var(--primary); cursor: pointer; }

        .transport-row { display: flex; justify-content: center; align-items: center; gap: 20px; }
        
        button { 
            background: rgba(255,255,255,0.1); border: none; color: white; 
            padding: 8px 15px; border-radius: 10px; cursor: pointer; font-weight: bold; 
            transition: 0.2s;
        }
        button:hover { background: rgba(255,255,255,0.2); }
        .active-btn { background: var(--primary) !important; }

        .play-btn-circle { width: 50px; height: 50px; background: white; color: black; border-radius: 50%; font-size: 20px; }
        
        .rec-btn { background: var(--danger); color: white; min-width: 100px; }
        .is-recording { animation: pulse 1s infinite; background: white !important; color: var(--danger) !important; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        .tools-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 8px; }

        #loginOverlay {
            position: fixed; inset: 0; background: #000; z-index: 9000;
            display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; text-align: center;
        }
        .intro-box { max-width: 600px; line-height: 1.6; margin-bottom: 10px; }
        .donation-links { display: flex; gap: 15px; margin: 15px 0; position: relative; z-index: 9005; flex-wrap: wrap; justify-content: center; }
        .donation-links a { padding: 12px 20px; border-radius: 12px; text-decoration: none; font-weight: bold; font-size: 14px; color: white; background: #333; border: 1px solid #555; transition: 0.3s; display: inline-block; }
        .btn-proceed { background: var(--primary); font-size: 20px; width: 200px; padding: 18px; margin: 10px; border: none; border-radius: 15px; color: white; cursor: pointer; position: relative; z-index: 9500; }
        .btn-home { background: #444; font-size: 16px; width: 220px; padding: 12px; margin-top: 15px; border: 1px solid #666; border-radius: 12px; color: white; text-decoration: none; font-weight: bold; display: inline-block; transition: 0.3s; position: relative; z-index: 9500; }
        .ad-container { width: 100%; max-width: 728px; min-height: 100px; margin: 10px auto; overflow: hidden; }

        #countdownOverlay {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 150px; font-weight: bold; color: #ffcc00; z-index: 5000; pointer-events: none; display: none; text-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        #saveContainer { 
            display: none; position: fixed; inset: 0; z-index: 9500; background: rgba(0,0,0,0.9);
            flex-direction: column; align-items: center; justify-content: center; padding: 20px;
        }
        #previewVid { max-width: 80%; max-height: 60vh; border-radius: 10px; margin-bottom: 20px; }
    </style>
</head>
<body>

    <div id="countdownOverlay"></div>

    <div id="loginOverlay">
        <h1 style="margin-bottom: 15px; color: var(--primary);">Form Mirror Pro for PC ver 1.2.3</h1>
        <div class="intro-box">
            <p style="font-size: 16px; margin: 0 0 10px 0; white-space: pre-wrap; color: #ddd;">ã“ã‚“ã«ã¡ã¯ï¼ä¾¿åˆ©ãªãƒ„ãƒ¼ãƒ«ã‚’é–‹ç™ºã—ã¦ã„ã‚‹ã‚¯ãƒªã‚¨ã‚¤ã‚¿ãƒ¼ã§ã™ã€‚ã“ã®ã‚¢ãƒ—ãƒªãŒã‚ãªãŸã®ã‚¹ãƒãƒ¼ãƒ„ã‚„ã‚¹ã‚­ãƒ«ã®ç·´ç¿’ã®å½¹ã«ç«‹ã¦ã°å¬‰ã—ã„ã§ã™ï¼å¿œæ´ã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ï¼</p>
            <p style="font-size: 14px; margin: 0; white-space: pre-wrap; color: #aaa;">Hi! I'm a creator. I hope this app helps your practice. Thank you for your support!</p>
            <p style="font-size: 12px; color: var(--primary); margin-top: 10px;">PCç‰ˆæ“ä½œï¼šãƒ‰ãƒ©ãƒƒã‚°ã§ç§»å‹•ã€ãƒ›ã‚¤ãƒ¼ãƒ«ã§ã‚ºãƒ¼ãƒ ãŒå¯èƒ½ã§ã™ã€‚</p>
        </div>

        <div class="ad-container">
            <ins class="adsbygoogle"
                 style="display:block"
                 data-ad-client="ca-pub-5115190227060860"
                 data-ad-slot="3577508619"
                 data-ad-format="auto"
                 data-full-width-responsive="true"></ins>
        </div>

        <div class="donation-links">
            <a href="https://github.com/KuniFami-Soft-Studio/form-mirror-pro-pc/wiki/Form-Mirror-Pro-for-PC-%E2%80%90-User-Manual" target="_blank" style="background: #28a745; border-color: #28a745;">ğŸ“– Manual</a>
            <a href="https://kunifami-soft-studio.github.io/form-mirror-pro-iphone/" target="_blank" style="background: #5856d6; border-color: #5856d6;">ğŸ’» iPhoneç‰ˆ</a>
            <a href="https://ofuse.me/dfee538b" target="_blank">ğŸ‡¯ğŸ‡µ OFUSEã§å¿œæ´</a>
            <a href="https://buymeacoffee.com/kunifami20w" target="_blank">ğŸŒ Buy Me a Coffee</a>
        </div>
        
        <div style="display: flex; flex-direction: column; align-items: center; margin-top: 10px;">
            <div style="display: flex; flex-wrap: wrap; justify-content: center;">
                <button class="btn-proceed" onclick="initAppWithLang('ja')">é–‹å§‹ (JP)</button>
                <button class="btn-proceed" onclick="initAppWithLang('en')" style="background: #5856d6;">Start (EN)</button>
            </div>
            <a href="https://kunifami-soft-studio.github.io/" class="btn-home">ğŸ  ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹ / Home</a>
        </div>
    </div>

    <div id="topPanel" class="top-bar fade-ui">
        <input type="file" id="fileInput" accept="video/*" onchange="loadVideo(event)" style="display:none;">
        <button id="loadBtn" onclick="document.getElementById('fileInput').click()">ğŸ“‚ å‹•ç”»èª­ã¿è¾¼ã¿</button>
        <button id="layoutBtn" onclick="switchLayout()">ğŸ“º è¡¨ç¤ºåˆ‡æ›¿</button>
        <button id="cameraBtn" onclick="switchCamera()">ğŸ”„ ã‚«ãƒ¡ãƒ©åˆ‡æ›¿</button>
        <button id="recordBtn" class="rec-btn" onclick="handleRecordClick()">â— éŒ²ç”»é–‹å§‹</button>
    </div>

    <canvas id="mainCanvas"></canvas>

    <div id="bottomPanel" class="bottom-panel fade-ui">
        <div class="sliders-row">
            <div class="slider-group"><span>ğŸ‘»</span><input type="range" id="ghostRange" min="0" max="100" value="0"></div>
            <div class="slider-group"><span>ğŸ’¡</span><input type="range" id="brightnessRange" min="100" max="400" value="100"></div>
            <div class="slider-group"><span>ğŸ”</span><input type="range" id="zoomRange" min="1" max="5" step="0.1" value="1" oninput="handleHardwareZoom(this.value)"></div>
        </div>

        <div style="display: flex; align-items: center; gap: 10px; width: 100%;">
            <span id="timeDisplay" style="font-size: 12px; min-width: 80px;">00:00 / 00:00</span>
            <input type="range" id="seekBar" value="0" step="0.1" style="flex: 1;">
        </div>

        <div class="transport-row">
            <button id="btnLoop" onclick="toggleLoop()">ğŸ” Loop</button>
            <button onclick="modelVid.currentTime -= 5">âª 5s</button>
            <button class="play-btn-circle" id="playPauseBtn" onclick="togglePlay()">â–¶</button>
            <button onclick="modelVid.currentTime += 5">5s â©</button>
            <div style="background: rgba(255,255,255,0.1); padding: 5px 10px; border-radius: 10px; display: flex; gap: 5px;">
                <button id="cd3" onclick="setCD(3)" class="active-btn">3s</button>
                <button id="cd5" onclick="setCD(5)">5s</button>
                <button id="cd7" onclick="setCD(7)">7s</button>
            </div>
        </div>

        <div class="tools-grid">
            <button id="mirrorModelBtn" class="active-btn" onclick="toggleMirror('model')">ğŸª è¦‹æœ¬åè»¢</button>
            <button id="mirrorMeBtn" class="active-btn" onclick="toggleMirror('me')">ğŸ¤³ è‡ªåˆ†åè»¢</button>
            <button id="gridBtn" onclick="cycleGrid()"># Grid</button>
            <button id="btnSpeed" onclick="changeSpeed()">âš¡ x1.0</button>
            <button id="delayBtn" onclick="cycleDelay()">â± 00:00 é…å»¶</button>
            <button id="qualityBtn" onclick="cycleQuality()">ğŸ¬ ç”»è³ª: Standard</button>
            <button id="fitModeBtn" onclick="toggleFitMode()">â†” Fit Mode</button>
            <button id="btnA" onclick="setPoint('A')">ğŸ“ A: --:--</button>
            <button id="btnB" onclick="setPoint('B')">ğŸ“ B: --:--</button>
            <button id="backABtn" style="background: var(--primary);" onclick="startCountdown('reset')">â†© Back A</button>
        </div>
    </div>

    <div id="saveContainer">
        <h2 id="saveLabel" style="color:white;">éŒ²ç”»å®Œäº†</h2>
        <video id="previewVid" controls></video>
        <div style="display:flex; gap:20px;">
            <button id="closeSaveBtn" onclick="closeSaveUI()" style="padding: 10px 30px; background: #555;">é–‰ã˜ã‚‹</button>
            <button id="downloadBtn" onclick="downloadVideo()" style="padding: 10px 30px; background: var(--primary);">PCã«ä¿å­˜ã™ã‚‹</button>
        </div>
    </div>

    <video id="modelVideo" loop playsinline style="display:none;"></video>
    <video id="myCamera" autoplay muted playsinline style="display:none;"></video>

    <script>
        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d', { alpha: false });
        const modelVid = document.getElementById('modelVideo');
        const myCam = document.getElementById('myCamera');
        const seekBar = document.getElementById('seekBar');
        const timeDisplay = document.getElementById('timeDisplay');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const recordBtn = document.getElementById('recordBtn');
        const cdOverlay = document.getElementById('countdownOverlay');

        // çŠ¶æ…‹ç®¡ç†
        let displayMode = 0, mediaRecorder = null, recordedChunks = [];
        let pointA = 0, pointB = 0, isLooping = false, lastBlob = null;
        let speeds = [1.0, 0.75, 0.5, 0.25, 1.25, 1.5], speedIdx = 0;
        let delayTimes = [0, 3, 5, 7], delayIdx = 0;
        let gridMode = 0;
        let countdownSec = 3, isCountingDown = false;
        let mirrorModel = true, mirrorMe = true, fitMode = "contain";
        let uiTimer = null, cameraBuffer = [];
        let videoDevices = [], currentDeviceIdx = 0;
        let currentLang = 'ja';

        const qualityModes = [
            { label: 'Low', bps: 1500000 },
            { label: 'Standard', bps: 5000000 },
            { label: 'High', bps: 15000000 }
        ];
        let qualityIdx = 1;

        const i18n = {
            ja: {
                load: "ğŸ“‚ å‹•ç”»èª­ã¿è¾¼ã¿", layout: "ğŸ“º è¡¨ç¤ºåˆ‡æ›¿", camera: "ğŸ”„ ã‚«ãƒ¡ãƒ©åˆ‡æ›¿", recStart: "â— éŒ²ç”»é–‹å§‹", recStop: "â–  åœæ­¢",
                mirrorModel: "ğŸª è¦‹æœ¬åè»¢", mirrorMe: "ğŸ¤³ è‡ªåˆ†åè»¢", delay: "é…å»¶", backA: "â†© Back A", 
                saveLabel: "éŒ²ç”»å®Œäº†", close: "é–‰ã˜ã‚‹", download: "PCã«ä¿å­˜ã™ã‚‹", quality: "ç”»è³ª"
            },
            en: {
                load: "ğŸ“‚ Load Video", layout: "ğŸ“º Layout", camera: "ğŸ”„ Camera", recStart: "â— Record", recStop: "â–  Stop",
                mirrorModel: "ğŸª Mirror Model", mirrorMe: "ğŸ¤³ Mirror Me", delay: "Delay", backA: "â†© Back A", 
                saveLabel: "Recording Finished", close: "Close", download: "Save to PC", quality: "Quality"
            }
        };

        const transformModel = { x: 0, y: 0, scale: 1.0 };
        const transformMe = { x: 0, y: 0, scale: 1.0 };
        let isDragging = false, lastMouseX = 0, lastMouseY = 0;
        let activeTransform = null;

        canvas.width = 1280; canvas.height = 720;

        function formatTime(s) {
            if (isNaN(s) || s < 0) return "00:00";
            const m = Math.floor(s / 60);
            const sec = Math.floor(s % 60);
            return `${m.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
        }

        function getTargetTransform(clientX) {
            if (displayMode === 0) {
                return clientX < window.innerWidth / 2 ? transformModel : transformMe;
            } else if (displayMode === 1) {
                return transformModel;
            } else {
                return transformMe;
            }
        }

        canvas.addEventListener('mousedown', (e) => {
            isDragging = true;
            lastMouseX = e.clientX;
            lastMouseY = e.clientY;
            activeTransform = getTargetTransform(e.clientX);
        });

        window.addEventListener('mousemove', (e) => {
            if (!isDragging || !activeTransform) return;
            const dx = (e.clientX - lastMouseX);
            const dy = (e.clientY - lastMouseY);
            const scaleX = canvas.width / window.innerWidth;
            const scaleY = canvas.height / window.innerHeight;
            activeTransform.x += (dx * scaleX) / activeTransform.scale;
            activeTransform.y += (dy * scaleY) / activeTransform.scale;
            lastMouseX = e.clientX;
            lastMouseY = e.clientY;
        });

        window.addEventListener('mouseup', () => { isDragging = false; activeTransform = null; });

        canvas.addEventListener('wheel', (e) => {
            e.preventDefault();
            const delta = e.deltaY > 0 ? 0.9 : 1.1;
            const target = getTargetTransform(e.clientX);
            target.scale = Math.min(Math.max(0.1, target.scale * delta), 10);
        }, { passive: false });

        async function initAppWithLang(lang) {
            currentLang = lang;
            document.getElementById('loginOverlay').style.display = 'none';
            
            const t = i18n[lang];
            document.getElementById('loadBtn').innerText = t.load;
            document.getElementById('layoutBtn').innerText = t.layout;
            document.getElementById('cameraBtn').innerText = t.camera;
            document.getElementById('recordBtn').innerText = t.recStart;
            document.getElementById('mirrorModelBtn').innerText = t.mirrorModel;
            document.getElementById('mirrorMeBtn').innerText = t.mirrorMe;
            document.getElementById('backABtn').innerText = t.backA;
            document.getElementById('saveLabel').innerText = t.saveLabel;
            document.getElementById('closeSaveBtn').innerText = t.close;
            document.getElementById('downloadBtn').innerText = t.download;
            updateDelayLabel();
            updateQualityLabel();

            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                videoDevices = devices.filter(d => d.kind === 'videoinput');
                await startCamera();
                showUI();
                requestAnimationFrame(render);
            } catch (e) { alert("Camera Error: " + e.message); }
        }

        async function startCamera() {
            if (myCam.srcObject) {
                myCam.srcObject.getTracks().forEach(t => t.stop());
            }
            const constraints = { 
                video: { 
                    deviceId: videoDevices[currentDeviceIdx]?.deviceId ? { exact: videoDevices[currentDeviceIdx].deviceId } : undefined,
                    width: { ideal: 1280 }, height: { ideal: 720 }
                } 
            };
            const stream = await navigator.mediaDevices.getUserMedia(constraints);
            myCam.srcObject = stream;
            cameraBuffer = [];
            // ã‚«ãƒ¡ãƒ©ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å¾Œã«å†ç”Ÿé–‹å§‹
            myCam.onloadedmetadata = () => myCam.play();
        }

        async function switchCamera() {
            currentDeviceIdx = (currentDeviceIdx + 1) % videoDevices.length;
            await startCamera();
        }

        async function handleHardwareZoom(val) {
            const track = myCam.srcObject?.getVideoTracks()[0];
            if (!track) return;
            const caps = track.getCapabilities();
            if (caps.zoom) {
                try { await track.applyConstraints({ advanced: [{ zoom: val }] }); } catch (e) { console.warn("Hardware zoom error"); }
            }
        }

        function render() {
            ctx.fillStyle = "#000"; ctx.fillRect(0, 0, canvas.width, canvas.height);

            if (myCam.readyState >= 2) {
                const temp = document.createElement('canvas');
                temp.width = myCam.videoWidth; temp.height = myCam.videoHeight;
                temp.getContext('2d').drawImage(myCam, 0, 0);
                cameraBuffer.push(temp);
                if (cameraBuffer.length > 60 * 10) cameraBuffer.shift(); // æœ€å¤§10ç§’ä¿æŒ
            }

            const delayFrames = Math.floor(delayTimes[delayIdx] * 60);
            const camFrame = cameraBuffer[Math.max(0, cameraBuffer.length - 1 - delayFrames)] || myCam;
            const br = document.getElementById('brightnessRange').value;
            const ghost = document.getElementById('ghostRange').value / 100;

            if (displayMode === 0) {
                draw(modelVid, 0, 0, 640, 720, mirrorModel, 100, 1, transformModel);
                draw(camFrame, 640, 0, 640, 720, mirrorMe, br, 1, transformMe);
                if (ghost > 0) draw(modelVid, 640, 0, 640, 720, mirrorModel, 100, ghost, transformModel);
            } else if (displayMode === 1) {
                draw(modelVid, 0, 0, 1280, 720, mirrorModel, 100, 1, transformModel);
            } else {
                draw(camFrame, 0, 0, 1280, 720, mirrorMe, br, 1, transformMe);
                if (ghost > 0) draw(modelVid, 0, 0, 1280, 720, mirrorModel, 100, ghost, transformModel);
            }

            if (gridMode > 0) drawGrids();
            requestAnimationFrame(render);
        }

        function draw(v, x, y, w, h, mirror, br, alpha, trans) {
            const isCanvas = v instanceof HTMLCanvasElement;
            const isVideo = v instanceof HTMLVideoElement;
            if (isVideo && v.readyState < 2) return;
            if (isCanvas && !v.width) return;

            ctx.save();
            ctx.beginPath(); ctx.rect(x, y, w, h); ctx.clip();
            ctx.globalAlpha = alpha;
            ctx.filter = `brightness(${br}%)`;
            ctx.translate(x + w / 2, y + h / 2);
            ctx.scale(trans.scale, trans.scale);
            ctx.translate(trans.x, trans.y);
            if (mirror) ctx.scale(-1, 1);

            const vw = isVideo ? v.videoWidth : v.width;
            const vh = isVideo ? v.videoHeight : v.height;
            if (!vw || !vh) { ctx.restore(); return; }

            const ratio = fitMode === "cover" ? Math.max(w/vw, h/vh) : Math.min(w/vw, h/vh);
            ctx.drawImage(v, -vw*ratio/2, -vh*ratio/2, vw*ratio, vh*ratio);
            ctx.restore();
        }

        function drawGrids() {
            ctx.save(); ctx.strokeStyle = "rgba(255,255,255,0.4)"; ctx.lineWidth = 1;
            const counts = [0, 0, 3, 5, 8, 12, 16];
            const n = counts[gridMode];
            if (gridMode === 1) {
                ctx.strokeStyle = "rgba(255,204,0,0.6)";
                ctx.beginPath(); ctx.moveTo(canvas.width/2, 0); ctx.lineTo(canvas.width/2, canvas.height); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(0, canvas.height/2); ctx.lineTo(canvas.width, canvas.height/2); ctx.stroke();
            } else {
                for(let i=1; i<n; i++){
                    ctx.beginPath(); ctx.moveTo(canvas.width*(i/n), 0); ctx.lineTo(canvas.width*(i/n), canvas.height); ctx.stroke();
                    ctx.beginPath(); ctx.moveTo(0, canvas.height*(i/n)); ctx.lineTo(canvas.width, canvas.height*(i/n)); ctx.stroke();
                }
            }
            ctx.restore();
        }

        function switchLayout() { displayMode = (displayMode + 1) % 3; resetUITimer(); }
        function toggleMirror(target) {
            if(target === 'model') mirrorModel = !mirrorModel;
            else mirrorMe = !mirrorMe;
            document.getElementById('mirrorModelBtn').classList.toggle('active-btn', mirrorModel);
            document.getElementById('mirrorMeBtn').classList.toggle('active-btn', mirrorMe);
            resetUITimer();
        }
        function cycleGrid() { gridMode = (gridMode + 1) % 7; resetUITimer(); }
        function cycleDelay() { delayIdx = (delayIdx + 1) % delayTimes.length; updateDelayLabel(); }
        function updateDelayLabel() {
            const timeStr = formatTime(delayTimes[delayIdx]);
            document.getElementById('delayBtn').innerText = `â± ${timeStr} ${i18n[currentLang].delay}`;
        }
        function cycleQuality() { qualityIdx = (qualityIdx + 1) % qualityModes.length; updateQualityLabel(); resetUITimer(); }
        function updateQualityLabel() {
            const q = qualityModes[qualityIdx];
            document.getElementById('qualityBtn').innerText = `ğŸ¬ ${i18n[currentLang].quality}: ${q.label}`;
            document.getElementById('qualityBtn').classList.toggle('active-btn', q.label === 'High');
        }
        function toggleFitMode() { fitMode = (fitMode === "contain" ? "cover" : "contain"); resetUITimer(); }
        function changeSpeed() { speedIdx = (speedIdx + 1) % speeds.length; modelVid.playbackRate = speeds[speedIdx]; document.getElementById('btnSpeed').innerText = `âš¡ x${speeds[speedIdx].toFixed(1)}`; }
        function setCD(s) { countdownSec = s; [3, 5, 7].forEach(v => document.getElementById(`cd${v}`).classList.toggle('active-btn', v === s)); }
        
        function handleRecordClick() {
            if (mediaRecorder?.state === "recording") stopRecording();
            else startCountdown('record');
        }

        function startCountdown(type) {
            isCountingDown = true; hideUI();
            let count = countdownSec;
            cdOverlay.style.display = 'block'; cdOverlay.innerText = count;
            modelVid.pause();
            const timer = setInterval(() => {
                count--;
                if (count > 0) cdOverlay.innerText = count;
                else {
                    clearInterval(timer); cdOverlay.style.display = 'none'; isCountingDown = false;
                    if (type === 'record') executeRecording();
                    else { modelVid.currentTime = pointA; modelVid.play(); playPauseBtn.innerText = "â¸"; }
                }
            }, 1000);
        }

        function executeRecording() {
            recordedChunks = [];
            const stream = canvas.captureStream(60);
            const types = ["video/webm;codecs=vp9", "video/webm;codecs=vp8", "video/webm"];
            let selectedType = types.find(t => MediaRecorder.isTypeSupported(t)) || "";
            
            try {
                mediaRecorder = new MediaRecorder(stream, { 
                    mimeType: selectedType, 
                    videoBitsPerSecond: qualityModes[qualityIdx].bps 
                });
                
                mediaRecorder.ondataavailable = e => { if (e.data.size > 0) recordedChunks.push(e.data); };
                mediaRecorder.onstop = () => {
                    lastBlob = new Blob(recordedChunks, { type: selectedType });
                    document.getElementById('previewVid').src = URL.createObjectURL(lastBlob);
                    document.getElementById('saveContainer').style.display = 'flex';
                };
                
                mediaRecorder.start();
                recordBtn.innerText = i18n[currentLang].recStop; 
                recordBtn.classList.add('is-recording');
                modelVid.currentTime = pointA; 
                modelVid.play(); 
                playPauseBtn.innerText = "â¸";
            } catch (err) {
                alert("éŒ²ç”»é–‹å§‹ã‚¨ãƒ©ãƒ¼: " + err.message);
                showUI();
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== "inactive") mediaRecorder.stop();
            modelVid.pause();
            playPauseBtn.innerText = "â–¶";
            recordBtn.innerText = i18n[currentLang].recStart; recordBtn.classList.remove('is-recording');
            showUI();
        }

        function togglePlay() {
            if (modelVid.paused) { modelVid.play(); playPauseBtn.innerText = "â¸"; }
            else { modelVid.pause(); playPauseBtn.innerText = "â–¶"; }
        }

        function loadVideo(e) {
            const f = e.target.files[0];
            if(f) {
                modelVid.src = URL.createObjectURL(f);
                modelVid.onloadedmetadata = () => {
                    seekBar.max = modelVid.duration;
                    pointA = 0; pointB = modelVid.duration;
                    document.getElementById('btnA').innerText = `ğŸ“ A: ${formatTime(pointA)}`;
                    document.getElementById('btnB').innerText = `ğŸ“ B: ${formatTime(pointB)}`;
                };
            }
        }

        function setPoint(p) {
            if (p === 'A') { 
                pointA = modelVid.currentTime; 
                document.getElementById('btnA').innerText = `ğŸ“ A: ${formatTime(pointA)}`; 
            } else { 
                pointB = modelVid.currentTime; 
                document.getElementById('btnB').innerText = `ğŸ“ B: ${formatTime(pointB)}`; 
            }
        }

        function toggleLoop() { isLooping = !isLooping; document.getElementById('btnLoop').classList.toggle('active-btn', isLooping); }
        function showUI() { document.querySelectorAll('.fade-ui').forEach(u => u.classList.add('ui-visible')); resetUITimer(); }
        function hideUI() { if(!modelVid.paused || isCountingDown) document.querySelectorAll('.fade-ui').forEach(u => u.classList.remove('ui-visible')); }
        function resetUITimer() { if (uiTimer) clearTimeout(uiTimer); uiTimer = setTimeout(hideUI, 4000); }
        canvas.addEventListener('click', () => showUI());

        function closeSaveUI() { document.getElementById('saveContainer').style.display = 'none'; }
        function downloadVideo() {
            const a = document.createElement('a');
            a.href = URL.createObjectURL(lastBlob);
            a.download = `form_check_${Date.now()}.webm`;
            a.click();
        }

        seekBar.oninput = () => { modelVid.currentTime = seekBar.value; };
        modelVid.ontimeupdate = () => {
            if (isLooping && modelVid.currentTime >= pointB) modelVid.currentTime = pointA;
            seekBar.value = modelVid.currentTime;
            timeDisplay.innerText = `${formatTime(modelVid.currentTime)} / ${formatTime(modelVid.duration || 0)}`;
        };
    </script>
    <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script>
</body>
</html>
